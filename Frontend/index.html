<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Context Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* User's existing body and base styles */
        body {
            font-family: 'Inter', Arial, sans-serif; /* Prioritize Inter, fallback to Arial */
            margin: 0;
            padding: 20px;
            background-color: #f0f4f8; /* Added from my version */
            color: #334155; /* Added from my version */
        }
        h1 {
            color: #0d6efd; /* User's color */
            text-align: center; /* Added for section-title consistency */
            font-size: 2.5rem; /* Adjusted for consistency */
            font-weight: bold; /* Adjusted for consistency */
            margin-bottom: 2rem; /* Adjusted for spacing */
        }

        /* User's existing button styles */
        button {
            padding: 8px 16px;
            margin-right: 10px;
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease; /* Added transition */
        }
        button:hover {
            background-color: #0b5ed7;
        }

        /* User's existing queue-box base styles */
        .queue-box {
            flex: 1;
            background-color: #f8f9fa;
            padding: 15px;
            border: 2px solid #0d6efd;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-width: 250px;
            height: auto; /* Changed to auto to allow content to define height */
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            /* Merged from my version */
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* User's existing queue-box hover and after */
        .queue-box:hover {
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .queue-box::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(to top, rgba(248,249,250,1), rgba(248,249,250,0));
            pointer-events: none;
        }

        /* User's existing queue-box h3 */
        .queue-box h3 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 0 10px 0;
            padding-bottom: 8px;
            color: #0d6efd;
            border-bottom: 2px solid #e0e0e0;
            width: 100%; /* Ensure it spans full width */
        }

        /* User's existing queue-count */
        .queue-count {
            background: #0d6efd;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }
        
        /* User's existing log-entry and its sub-styles */
        .log-entry {
            border-left: 4px solid #ddd;
            padding: 12px;
            margin: 6px 0;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-radius: 6px;
            position: relative;
        }
        .log-entry::before {
            content: '';
            position: absolute;
            top: 0;
            left: -4px;
            height: 100%;
            width: 4px;
            background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .log-entry:hover::before {
            opacity: 1;
        }
        .log-entry:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .message-header {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
        }
        .message-id {
            font-weight: bold;
            color: #333;
        }
        .message-type {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .message-type.message { background: #e6f7ff; }
        .message-type.alert { background: #ffebee; }
        .message-priority {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            background: #f5f5f5;
        }
        .priority-1 { background: #e8f5e9 !important; }
        .priority-2 { background: #c8e6c9 !important; }
        .priority-3 { background: #a5d6a7 !important; }
        .priority-4 { background: #81c784 !important; }
        .message-content {
            margin: 4px 0;
        }
        .message-footer {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #666;
        }
        .message-status {
            font-weight: bold;
        }
        .status-pending { color: #ff9800; }
        .status-urgent { color: #f44336; }
        .status-processing { color: #2196f3; }
        .status-processed { color: #4caf50; }
        .log-overflow {
            color: red;
            font-weight: bold;
            padding: 5px;
            background-color: #f8d7da;
        }
        
        /* User's existing queue-log and log-content */
        .queue-log, .log-content, pre {
            flex-grow: 1;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            background-color: white;
            padding: 8px;
            border: 1px solid #e0e0e0;
            margin-top: 10px;
            max-height: 400px;
            min-height: 200px;
            border-radius: 4px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            scrollbar-width: thin;
            scrollbar-color: #0d6efd #f0f0f0;
            white-space: pre-wrap; /* Changed from pre to pre-wrap for better wrapping */
            overflow-wrap: break-word;
            display: flex;
            flex-direction: column;
        }

        .log-box {
            background-color: #f8f9fa;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #logsContainer {
            margin-top: 30px;
        }

        .queue-log::-webkit-scrollbar {
            width: 8px;
        }

        .queue-log::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 4px;
        }

        .queue-log::-webkit-scrollbar-thumb {
            background-color: #0d6efd;
            border-radius: 4px;
        }

        @keyframes highlightNew {
            0% { background-color: rgba(13, 110, 253, 0.1); }
            100% { background-color: transparent; }
        }

        .new-entry {
            animation: highlightNew 1.5s ease-out;
        }
        
        /* User's existing queue-header, queue-items, queue-item */
        .queue-header {
            display: flex;
            font-weight: bold;
            padding: 5px;
            background: #f0f0f0;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .queue-header span {
            flex: 1;
            text-align: center;
        }
        .queue-items {
            flex: 1;
            overflow-y: auto;
        }
        .queue-item {
            display: flex;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .queue-item span {
            flex: 1;
            text-align: center;
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Add ellipsis */
            white-space: nowrap; /* Prevent wrapping */
        }
        #queueDisplay .last-message {
            background-color: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
        }

        /* My new styles (merged and adapted) */
        .container-card {
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        /* Adjusted queue-box h3 for clarity and to fit with tailwind/user styles */
        .queue-box h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937; /* Adjusted color for better contrast */
        }
        .queue-box p.description {
            font-size: 0.875rem;
            color: #4b5563;
            margin-top: 0.5rem;
        }
        .queue-box p.direction {
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.25rem;
        }
        .arrow-icon {
            color: #9ca3af;
            font-size: 3rem;
            font-weight: bold;
        }
        .section-title {
            font-size: 2.25rem;
            font-weight: 800;
            text-align: center;
            color: #111827;
            margin-bottom: 2rem;
        }
        .subsection-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        .message-log-item {
            padding: 0.5rem;
            border-radius: 0.375rem;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }
        .message-log-item.sent {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .message-log-item.received {
            background-color: #d1fae5;
            color: #065f46;
        }
        .message-log-item.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .flow-description {
            background-color: #f9fafb;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.05) inset;
            border: 1px solid #e5e7eb;
        }
        .flow-description h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }
        .flow-description p {
            color: #374151;
            margin-bottom: 0.5rem;
        }
        .flow-description ul {
            list-style-type: disc;
            padding-left: 1.25rem;
            margin-bottom: 0.5rem;
        }
        .flow-description li {
            color: #374151;
        }

        /* Specific queue box colors */
        .queue-box.frontend-origin { background-color: #e0f2fe; border-color: #0d6efd; } /* Light blue */
        .queue-box.backend-inbound { background-color: #fff3cd; border-color: #ffc107; } /* Light yellow-orange */
        .queue-box.backend-outbound { background-color: #d4edda; border-color: #28a745; } /* Light green */
        .queue-box.dead-letter { background-color: #f8d7da; border-color: #dc3545; } /* Light red */

        /* Layout for the main queue flow */
        #queuesFlowContainer {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            grid-template-rows: auto auto auto;
            gap: 20px;
            align-items: stretch;
        }

        .queue-box {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .flow-connector {
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .flow-connector {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 100px; /* Ensure space for arrows/text */
            margin-top: 20px; /* Space between rows */
            margin-bottom: 20px;
        }
        .flow-connector span.arrow-icon {
            margin-bottom: 5px;
        }
        .flow-connector p {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }

        /* Ensure queue-box content (queue-log) fills space */
        .queue-box .queue-log {
            width: 100%;
            flex-grow: 1;
            min-height: 50px; /* Ensure it has some height even if empty */
            box-sizing: border-box; /* Include padding in width/height calculation */
        }
        /* Override Tailwind's default button styles to keep user's specific ones */
        #startSim, #stopSim, #testButton {
            /* These apply a baseline style that the user's specific button style overrides. */
            padding: 0.5rem 1rem; /* px-4 py-2 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); /* shadow-md */
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
        }
        #startSim {
            background-color: #2563eb; /* bg-blue-600 */
            color: #fff; /* text-white */
        }
        #startSim:hover {
            background-color: #1d4ed8; /* hover:bg-blue-700 */
        }
        #stopSim {
            background-color: #dc2626; /* bg-red-600 */
            color: #fff; /* text-white */
        }
        #stopSim:hover {
            background-color: #b91c1c; /* hover:bg-red-700 */
        }
        #testButton {
            background-color: #16a34a; /* bg-green-600 */
            color: #fff; /* text-white */
        }
        #testButton:hover {
            background-color: #15803d; /* hover:bg-green-700 */
        }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto container-card">
        <h1 class="section-title">Context Translator Queue System Visualizer</h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-center mb-12">
            <div class="queue-box frontend-origin h-auto p-6">
                <h2 class="text-2xl font-semibold text-blue-800">Frontend (Browser UI)</h2>
                <p class="text-gray-600 mt-2">Your web interface for user interaction.</p>
                <div class="mt-4 flex flex-wrap justify-center gap-2">
                    <button id="startSim">Start Simulation</button>
                    <button id="stopSim">Stop Simulation</button>
                    <button id="testButton">Send Test Message</button>
                </div>
            </div>

            <div class="flex flex-col items-center justify-center">
                <span class="arrow-icon">↔</span>
                <p class="text-gray-600 text-sm mt-2">WebSocket Communication</p>
            </div>

            <div class="queue-box bg-gray-50 h-auto p-6">
                <h2 class="text-2xl font-semibold text-gray-800">Backend Application</h2>
                <p class="text-gray-600 mt-2">All Python services and internal queues run here.</p>
                <p class="text-sm text-gray-500 mt-2">(FastAPI, Uvicorn, Asyncio)</p>
            </div>
        </div>

        <div id="statusMonitor" class="mt-8 p-4 bg-gray-100 rounded-lg shadow-inner text-center">
            <h2 class="subsection-title">System Status</h2>
            <div class="grid grid-cols-2 gap-4 text-lg">
                <div>Connection: <span id="connectionStatus" class="font-semibold text-gray-700">Disconnected</span></div>
                <div>Simulation: <span id="simulationStatus" class="font-semibold text-gray-700">Not Running</span></div>
                <div>Last Update: <span id="lastUpdate" class="font-semibold text-gray-700">Never</span></div>
                <div>Message Count: <span id="messageCount" class="font-semibold text-gray-700">0</span></div>
            </div>
        </div>

        <div class="flex flex-col items-center mt-12 mb-12">
            <h2 class="subsection-title">Backend Internal Queue Flow</h2>
            <div id="queuesFlowContainer" class="w-full">
                <div class="queue-box frontend-origin col-start-1 row-start-1">
                    <h3>From Frontend Queue <span id="fromFrontendCount" class="queue-count">0</span></h3>
                    <p class="direction text-blue-700">📥 Inbound from Frontend</p>
                    <p class="description">Messages received from clients via WebSocket, awaiting initial processing.</p>
                    <div id="fromFrontendQueueDisplay" class="queue-log">
                        <div class="queue-header">
                            <span>Type</span>
                            <span>ID</span>
                            <span>Status</span>
                            <span>Timestamp</span>
                        </div>
                        <div class="queue-items"></div>
                    </div>
                </div>

                <div class="flow-connector col-start-2 row-start-1">
                    <span class="arrow-icon">→</span>
                    <p>QueueForwarder</p>
                </div>

                <div class="queue-box backend-inbound col-start-3 row-start-1">
                    <h3>To Backend Queue <span id="toBackendCount" class="queue-count">0</span></h3>
                    <p class="direction text-yellow-700">➡️ Internal Processing</p>
                    <p class="description">Messages forwarded for core backend logic (e.g., commands, data).</p>
                    <div id="toBackendQueueDisplay" class="queue-log">
                        <div class="queue-header">
                            <span>Type</span>
                            <span>ID</span>
                            <span>Status</span>
                            <span>Timestamp</span>
                        </div>
                        <div class="queue-items"></div>
                    </div>
                </div>

                <div class="queue-box dead-letter col-start-4 row-start-1 row-span-2 flex flex-col justify-center items-center">
                    <h3>Dead Letter Queue <span id="deadLetterCount" class="queue-count bg-red-600">0</span></h3>
                    <p class="direction text-red-700">🗑️ Error Handling</p>
                    <p class="description">Malformed or unprocessable messages are stored here for audit.</p>
                    <span class="text-3xl text-red-500 mt-2">🚨</span>
                    <p class="text-xs text-gray-500 mt-1">Populated by all services</p>
                    <div id="deadLetterQueueDisplay" class="queue-log"></div>
                </div>

                <div class="queue-box backend-outbound col-start-1 row-start-2">
                    <h3>From Backend Queue <span id="fromBackendCount" class="queue-count">0</span></h3>
                    <p class="direction text-green-700">⬅️ Inbound from Backend Services</p>
                    <p class="description">Messages from internal backend services, often responses or data for processing.</p>
                    <div id="fromBackendQueueDisplay" class="queue-log">
                        <div class="queue-header">
                            <span>Type</span>
                            <span>ID</span>
                            <span>Status</span>
                            <span>Timestamp</span>
                        </div>
                        <div class="queue-items"></div>
                    </div>
                </div>

                <div class="flow-connector col-start-3 row-start-2">
                    <span class="arrow-icon">↓</span>
                    <p>MessageProcessor</p>
                </div>

                <div class="queue-box backend-outbound col-start-3 row-start-3">
                    <h3>To Frontend Queue <span id="toFrontendCount" class="queue-count">0</span></h3>
                    <p class="direction text-green-700">📤 Outbound to Frontend</p>
                    <p class="description">Responses and updates ready to be sent back to clients.</p>
                    <div id="toFrontendQueueDisplay" class="queue-log">
                        <div class="queue-header">
                            <span>Type</span>
                            <span>ID</span>
                            <span>Status</span>
                            <span>Timestamp</span>
                        </div>
                        <div class="queue-items"></div>
                    </div>
                </div>

                <div class="flow-connector col-start-2 row-start-3">
                    <span class="arrow-icon">↔</span>
                    <p>WebSocket Communication</p>
                </div>
            </div>
        </div>

        <div id="logsContainer" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="log-box">
                <h3>System Log</h3>
                <pre id="system_log" class="log-content"></pre>
            </div>
            <div class="log-box">
                <h3>Simulation Log</h3>
                <pre id="simulation_log" class="log-content"></pre>
            </div>
            <div class="log-box">
                <h3>Status Log</h3>
                <pre id="status_log" class="log-content"></pre>
            </div>
            <div class="log-box">
                <h3>Test Log</h3>
                <pre id="test_log" class="log-content"></pre>
            </div>
        </div>

        <div class="mt-12 flow-description">
            <h3 class="subsection-title">Understanding the Queue Flow</h3>
            <p>This system uses a series of internal queues within the Python backend to manage the flow of messages between the frontend (your browser UI) and various backend services. This asynchronous architecture ensures that the application remains responsive and can handle multiple operations concurrently.</p>
            
            <p>Here's how messages typically flow:</p>
            <ul>
                <li><strong>1. Frontend to `from_frontend_queue` (Inbound):</strong>
                    When you interact with the UI (e.g., click "Send Ping" or "Send Command"), your browser sends a JSON message over a WebSocket connection to the backend. The `WebSocketManager` in the backend receives this raw message, validates it against the `WebSocketMessage` schema, and then places it into the <strong><code>from_frontend_queue</code></strong>. This queue acts as the initial entry point for all client-originated messages.</li>
                
                <li><strong>2. `from_frontend_queue` to `to_backend_queue` (Forwarding):</strong>
                    A dedicated background service called the <strong><code>QueueForwarder</code></strong> continuously monitors the <code>from_frontend_queue</code>. Its job is to pick up messages from here and forward them to the <strong><code>to_backend_queue</code></strong>. This step ensures a clean separation between message reception and core backend processing.</li>
                
                <li><strong>3. `to_backend_queue` to `MessageProcessor` (Processing):</strong>
                    The <strong><code>MessageProcessor</code></strong> is the central brain for handling most backend logic. It constantly dequeues messages from the <strong><code>to_backend_queue</code></strong>. Based on the message's `type` (e.g., 'command', 'ping', 'data'), it performs the necessary actions, such as interacting with the `SimulationManager` for 'start_simulation' commands or generating a 'pong' response for 'ping' messages.</li>
                
                <li><strong>4. `from_backend_queue` (Internal Inbound from Backend Services):</strong>
                    This queue is used for messages originating from other backend services or internal processing steps that need to eventually reach the `MessageProcessor` or `to_frontend_queue`. It acts as an internal intermediary for results or commands coming back from deeper backend components.</li>
                
                <li><strong>5. `MessageProcessor` to `to_frontend_queue` (Outbound Responses):</strong>
                    After processing a message (whether from `to_backend_queue` or potentially directly from `from_backend_queue` depending on internal logic), if a response or status update needs to be sent back to the frontend, the <code>MessageProcessor</code> constructs a new `WebSocketMessage` (e.g., a 'status' message or a 'pong' message) and places it into the <strong><code>to_frontend_queue</code></strong>.</li>
                
                <li><strong>6. `to_frontend_queue` to Frontend (Sending):</strong>
                    The `WebSocketManager` has another background task (the sender) that actively listens to the <strong><code>to_frontend_queue</code></strong>. When it finds a message, it sends it over the appropriate WebSocket connection back to the original frontend client, completing the round trip.</li>
                
                <li><strong>The `dead_letter_queue` (Error Handling):</strong>
                    Throughout this entire flow, if any service (like `WebSocketManager`, `QueueForwarder`, or `MessageProcessor`) encounters a message that is malformed, unprocessable, or causes an unexpected error, that problematic message is routed to the <strong><code>dead_letter_queue</code></strong>. This prevents bad messages from blocking the system and allows developers to inspect them later for debugging and analysis without interrupting the main application flow.</li>
            </ul>
            <p class="mt-4 text-sm text-gray-500">The 1-second delays after dequeuing from each queue (`from_frontend_queue`, `to_backend_queue`, `to_frontend_queue`) are temporarily added to help visualize the message movement in your backend logs.</p>
        </div>
    </div>

    <script>
        // Add this to your frontend.js later
        function updateQueueCounters() {
            // These global variables are assumed to be defined in app.js or another linked script
            // and represent instances of your queue data structures on the frontend.
            if (typeof toFrontendQueue !== 'undefined' && toFrontendQueue.size) {
                document.getElementById('toFrontendCount').textContent = toFrontendQueue.size();
            }
            if (typeof fromFrontendQueue !== 'undefined' && fromFrontendQueue.size) {
                document.getElementById('fromFrontendCount').textContent = fromFrontendQueue.size();
            }
            if (typeof toBackendQueue !== 'undefined' && toBackendQueue.size) {
                document.getElementById('toBackendCount').textContent = toBackendQueue.size();
            }
            // Corrected: fromBackendQueueDisplay will now be found
            if (typeof fromBackendQueue !== 'undefined' && fromBackendQueue.size) {
                document.getElementById('fromBackendCount').textContent = fromBackendQueue.size();
            }
            // Assuming a deadLetterQueue is also exposed for debugging purposes
            if (typeof deadLetterQueue !== 'undefined' && deadLetterQueue.size) {
                 document.getElementById('deadLetterCount').textContent = deadLetterQueue.size();
            }
        }
    </script>
    
    <script type="module">
        import { initializeApplication } from './src/app.js';
        
        // Extended WebSocket handling
        class SimulationObserver {
            constructor() {
                this.messageHandlers = {
                    'connection_ack': this.handleConnectionAck,
                    'status': this.handleStatusUpdate,
                    'pong': this.handlePong,
                    'error': this.handleError
                };
            }

            handleMessage(message) {
                const handler = this.messageHandlers[message.type];
                if (handler) {
                    handler(message);
                } else {
                    console.warn('Unhandled message type:', message.type);
                }
            }

            handleConnectionAck(msg) {
                document.getElementById('connectionStatus').textContent = 'Connected';
                document.getElementById('connectionStatus').className = 'font-semibold text-green-600';
                console.log('Connection established:', msg.data);
            }

            handleStatusUpdate(msg) {
                if (msg.data.status === 'running') {
                    document.getElementById('simulationStatus').textContent = 'Running';
                    document.getElementById('simulationStatus').className = 'font-semibold text-green-600';
                }
                updateSimulationLog(msg);
            }

            // Other handler methods...
        }

        // Initialize with enhanced observer
        initializeApplication(new SimulationObserver());
    </script>
</body>
</html>
