# Context Translator Frontend (Electron)

Desktop-only Electron app rendering real-time AI explanations from the backend. This folder contains the complete Electron app (main, preload, renderer) plus shared Lit components and styles.

Tip: The old web/PWA path is removed. Everything here targets Electron.

## Quickstart

Prerequisites

- Node.js LTS (18+ recommended)
- npm
- Backend available at ws://localhost:8000 (see project root README for backend setup)

Install and run (from this Frontend folder)

```powershell
npm install
npm run dev
```

This starts:

- Vite dev server on <http://localhost:5174> for the renderer
- esbuild watch for the preload script
- Electron with live-reload

(For Electron developement only. Will not start the Backend and a Websocket connections will not be possible. Use `run_electron.py` script in root folder instead.)

## Manual Explain Feature

In the Explanations tab, you can directly request an explanation for any term:

- Enter a term in the "Explain a term" field and click "Explain" (or press Enter).
- The app sends a `manual.request` message to the backend.
- The backend enqueues the term into the detection pipeline; once processed, a new explanation appears automatically in the list.

Notes:

- Requires an active WebSocket connection to the backend at `ws://localhost:8000`.
- The pipeline uses the same MainModel and ExplanationDeliveryService as automatic detections.

## Folder structure

``` text
Frontend/
├─ index.html                # Renderer entry (loaded by Vite in dev, by file in prod)
├─ package.json              # App metadata, scripts, electron-builder config
├─ vite.config.js            # Vite config (renderer dev/build)
└─ src/
   ├─ main.js                # Electron main process (creates window, CSP, menus)
   ├─ preload.js             # Preload (CommonJS) exposing safe Electron APIs
   ├─ renderer.js            # Renderer entry; defines <my-element> for Electron
   └─ components/            # Shared UI components and utilities
      ├─ index.js            # Barrel exports for all shared components
      ├─ index.css           # Global styles consumed via styles.js
      ├─ styles.js           # Lit css import and export
      ├─ ui.js               # Base Lit component (tabs, session UI, list)
      ├─ explanation-item.js         # Markdown-capable explanation card component
      ├─ explanation-manager.js      # Centralized explanation store
      ├─ explanation-constants.js    # Constants for explanation handling
      ├─ universal-message-parser.js # Backend message to explanation converter
      ├─ main-body.js                # Main application body component
      ├─ setup-tab.js                # Configuration interface component
      ├─ explanations-tab.js         # Explanations management component
      ├─ chat-box.js                 # Direct AI chat interface component
      ├─ status-bar.js               # Server status and microphone status component
      ├─ status-bar.test.js          # Test file for the status bar component
      └─ ui-original.js              # Original UI component (backup)
```

(All folder named something like `dist` are generated by the electron build process and should not be edited/committed to Git.)

## Architecture overview

- Main process: `src/main.js`
  - Creates the `BrowserWindow`, sets CSP, logs renderer console output, and exposes IPC handlers (settings, version, platform, user session id).
  - In dev, loads <http://localhost:5174>. In production, loads the built `dist/index.html` file.
- Preload: `src/preload.js`
  - CommonJS bundle exposed via `contextBridge` as `window.electronAPI` (get/save settings, dialogs, app info, user session id).
- Renderer: `src/renderer.js`
  - Defines `ElectronMyElement` extending the shared `UI` base; registers `<my-element>`.
  - Establishes a WebSocket to `ws://localhost:8000/ws/{client_id}` and handles session start/join flows.
  - Uses the shared styles and components.
- Shared UI components and logic: `src/shared/*`
  - `ui.js`: tabs, session code UI, buttons wiring (base methods `_startSession`/`_joinSession` to override)
  - `explanation-item.js`: a markdown-capable card component (expand, pin, delete, copy)
  - `explanation-manager.js`: singleton store with pinning/sorting and sessionStorage persistence
  - `universal-message-parser.js`: converts backend UniversalMessage shapes into explanation items
  - `chat-box.js`: direct AI chat interface component
  - `setup-tab.js`: configuration interface component
  - `explanations-tab.js`: explanations management component
  - `status-bar.js`: server status and microphone status component
  - `main-body.js`: main application body component

Data flow (today)

- Renderer opens WebSocket and forwards session actions (`session.start`, `session.join`).
- Incoming messages are handled in `renderer.js` (e.g., `session.created`, `session.joined`).
- Explanations can be added through `explanationManager.addExplanation(...)` or by using `UniversalMessageParser`.

Note: Parser integration for incoming explanation messages can be extended by calling `UniversalMessageParser.parseAndAddToManager(message, explanationManager)` when appropriate.

## Scripts and commands

From the `Frontend` directory:

- Development
  - `npm run dev` — concurrent dev (preload watch, Vite on 5174, Electron)
  - `npm run dev:renderer` — Vite dev server only
  - `npm run dev:preload` — esbuild watch for preload only
  - `npm run dev:main` — start Electron after dev assets are ready
- Build
  - `npm run build` — clean + build preload + renderer + package metadata
  - `npm run build:preload` — bundle preload (CJS) to `dist-electron/preload.js`
  - `npm run build:renderer` — Vite build to `dist`
  - `npm run build:main` — package skeleton via electron-builder (`--dir`)
- Packaging
  - `npm run package` — create unpacked build in `dist-electron`
  - `npm run dist` — create distributables (platform-specific)
- Utilities
  - `npm run start` — run Electron using current files (no watchers)
  - `npm run clean` / `npm run build:clean` — remove `dist` and `dist-electron`

Ports

- Renderer dev server: 5174 (see `vite.config.js`)
- Backend WebSocket: 8000 (see `src/renderer.js` and CSP in `src/main.js`)

## Installation and running

1) Install dependencies

```powershell
cd .\Frontend
npm install
```

1) Start the frontend in development

```powershell
npm run dev
```

1) Ensure the backend is running at ws://localhost:8000. The renderer will connect automatically.

Optional: Pass a user session id to Electron on startup. The main process reads `--user-session-id=...` and exposes it to the renderer via `electronAPI.getUserSessionId()`.

## Tech stack

- Electron (main, preload, renderer)
- Lit (web components)
- Material Web (M3 components)
- Vite (renderer dev/build)
- esbuild (preload bundling)
- electron-builder (packaging)

## Packages

Runtime

- @material/web ^2.3.0
- lit ^3.3.0
- marked ^15.0.12

Dev

- electron ^29.1.6
- vite ^6.3.5
- esbuild ^0.25.8
- electron-builder ^24.6.4
- concurrently ^8.2.2
- cross-env ^7.0.3
- rimraf ^5.0.5
- wait-on ^7.0.1

## Files of interest

- `src/main.js` — app lifecycle, window, CSP, IPC, menus
- `src/preload.js` — safe API surface to the renderer (CommonJS)
- `src/renderer.js` — WebSocket session logic + custom element definition
- `src/shared/ui.js` — base component with tabs and session controls
- `src/shared/explanation-manager.js` — centralized explanation store
- `src/shared/universal-message-parser.js` — map backend messages to explanations
- `src/shared/explanation-item.js` — markdown rendering and actions component
- `src/shared/chat-box.js` — direct AI chat interface component
- `src/shared/status-bar.js` — status display component
- `src/shared/styles.js` and `src/shared/index.css` — styles system

## Backend integration

- WebSocket URL pattern: `ws://localhost:8000/ws/{client_id}`
- Message types handled in the renderer today: `frontend.init` (out), `session.start` (out), `session.join` (out), `session.created` (in), `session.joined` (in), `session.error` (in)
- Content Security Policy allows connections to localhost:5174 and localhost:8000 (see `src/main.js`).

## Troubleshooting

- Electron opens a blank window in dev:
  - Verify Vite is on 5174 and `dist-electron/preload.js` exists (created by `dev:preload`).
- WebSocket fails to connect:
  - Ensure the backend is running and reachable at `ws://localhost:8000`.
- Icons or fonts missing:
  - Internet connectivity is required for Google Fonts in `index.html` during development.

## Documentation and links

- Frontend architecture: This document
- Project root README: one level up at `../README.md`
- Lit docs: <https://lit.dev/>
- Vite docs: <https://vite.dev/guide/>
- Electron docs: <https://www.electronjs.org/docs/latest>
- Material Web: <https://material-web.dev/>

## Contributing notes

- Preload is generated into `dist-electron/preload.js` — edit `src/preload.js` instead.
- Keep shared logic within `src/shared` and export via `src/shared/index.js`.
- Avoid introducing new frameworks; prefer small, focused changes.
